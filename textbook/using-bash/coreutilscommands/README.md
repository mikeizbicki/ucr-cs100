# Coreutils

As described by its [GNU page](https://www.gnu.org/software/coreutils/), coreutils is a set of utilities that provide file, shell, and text manipulation. It is not part of Unix, but it does ship with virtually every Unix package. 

## chroot

`[chroot man page] (http://linux.die.net/man/2/chroot)`  is a command used to run other commands in a limited environment by assigning a new root to the calling process. If a command argument is provided, `chroot` executes a single command in a limited environment. Upon success `/` points to the path supplied as an argument. This requires a privileged process, as indicated by `CAP_SYS_CHROOT`, which is further described in the [capabilities man page](http://linux.die.net/man/7/capabilities). Lacking the appropriate permission to call `chroot` or search permission on a component of the path prefix of newroot will result in a runtime error.

```
kav@debian:/home/kav$ mkdir newroot
kav@debian:/home/kav$ chroot newroot
chroot: cannot change root directory to newroot: Operation not permitted
```
If `chroot` is called from bash, the root folder must contain a copy of `bash` and all of its dependencies. Otherwise this will result in a runtime error. Here [`sudo`](http://linux.die.net/man/8/sudo) is used to execute `chroot` with the required permissions. 
```
kav@debian:/home/kav$ sudo chroot newroot
chroot: failed to run command `/bin/bash': No such file or directory
```
The error here can be remedied by determining bash's runtime dependencies and making copies in the root folder.

```
kav@debian:/home/kav$ which bash
/bin/bash
kav@debian:/home/kav$ ldd /bin/bash
linux-vdso.so.1 =>  (0x00007fffd0dff000)
libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f7451e80000)
libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f7451c7c000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f74518ef000)
/lib64/ld-linux-x86-64.so.2 (0x00007f74520bd000)
```
Here are the man pages for [`which`](http://linux.die.net/man/1/which), [`ldd`](linux.die.net/man/1/ldd), and [`cp`](http://linux.die.net/man/1/cp). 
```
kav@debian:/home/kav$ cp /lib/x86_64-linux-gnu/libtinfo.so.5 newroot
kav@debian:/home/kav$ cp /lib64/ld-linux-x86-64.so.2 newroot
kav@debian:/home/kav$ cp /lib/x86_64-linux-gnu/libc.so.6 newroot
kav@debian:/home/kav$ cp /lib/x86_64-linux-gnu/libdl.so.2 newroot
kav@debian:/home/kav$ cp /bin/bash /newroot/bin/bash
kav@debian:/home/kav$ cp /bin/bash /newroot/bin/bash
kav@debian:/home/kav$ sudo chroot newroot
```
It might be safer to run this last command as a subshell to avoid potential problems. Be careful when running `sudo`.  

```
kav@debian:/home/kav$ (sudo chroot newroot)
```

The resulting shell will be constrained compared to the original, as it can only access folders that are accessible from newroot unless file descriptors were previously passed in.


## env 

[`env`](http://linux.die.net/man/1/env) allows a command to be run in a modified environment. There is no limit to the number of environment variables that may be specified when running `env`. If no variables are specified `env` prints out the full list of environment variables. The list generated list is equivalent to the one generated by [`printenv`](http://linux.die.net/man/1/printenv) with no arguments specified. 
```
kkamg001@hammer $ printenv EDITOR
emacs
```
Blasphemy!
Let's say we want to begin a new shell with custom settings.
`env - EDITOR=vim LOGNAME=bruce HISTSIZE=200 HOME=/home/csmajs/kkamg001 /bin/bash`
```
kkamg001@hammer $ env - EDITOR=vim LOGNAME=bruce HISTSIZE=200 HOME=/home/csmajs/kkamg001 /bin/bash
~
kkamg001@hammer $ printenv EDITOR
vim
~
kkamg001@hammer $ printenv LOGNAME
bruce
~
kkamg001@hammer $ printenv HISTSIZE
100
~
kkamg001@hammer $ exit   
exit
~
kkamg001@hammer $ printenv EDITOR
emacs
~
kkamg001@hammer $ printenv LOGNAME
kkamg001
~
kkamg001@hammer $ 
```

Apart from the limit on history size, all other variables were updated until we exited that shell instance. It's also possible to ignore the current environment, in which case default variables will be used.

```
root@debian:/home/kav# env -i sh
# env
PWD=/home/kav
```

Adding the variable name to this example

```PWD=/home/kav
# env name=Batman
```

If a value is not specified for an environment variable, it takes on a `null` value and remains in the list. 
```
#env name=
PWD=/home/kav
name=
```

The ` -u ` flag can be invoked to remove an environment variable. Some variables will be recreated without user input due to dependencies. Otherwise they will not appear in the list. If the `-i` flag is used, the command will start with an empty environment.


If `env` is run in a shell setting without additional arguments, it will print out a list of environment variables associated with the current user. This is equivalent to [`printenv`](http://linux.die.net/man/1/printenv), which brings up a complete list of environment variables. 

## nice
`nice` allows a user to run a process with modified priority, commonly referred to as niceness. A value of 0 is the default priority for task scheduling. Any user may specify that a greater niceness value, indicating that a process should be run with lower prioritization relative to other concurrent operations. The maximum is 19. If no adjustment is specified, `nice` will default to an increase of 10. Assume all files from a given path must be backed up via `cron` script every hour with minimum performance penalty to other concurrent processes. To backup the rather large file `linux.words` the script might run something like
```
mkdir .backupfolder
nice -n 19 cp -r /usr/share/dict/linux.words .backupfolder 
```
This allows the copy process to inhibit other running processes as little as possible. Increased scheduling priority may also be specified if the process has the privilege `CAP_SYS_NICE`. Every process has some assigned level of niceness. Niceness of all running processes can be seen by typing `ps l -U $USER` to print the long version of all processes owned by the current user. To modify 
```
kkamg001@hammer $ ps l -U $USER
F   UID   PID  PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND
5 41247 32313 32304  20   0 104348  2344 poll_s S    ?          0:00 sshd: kkamg001@pts/0
0 41247 32314 32313  20   0 112576  1928 n_tty_ Ss+  pts/0      0:00 -bash
5 41247 33125 33116  20   0 104348  2352 ?      S    ?          0:00 sshd: kkamg001@pts/1
0 41247 33126 33125  20   0 112576  1920 wait   Ss   pts/1      0:00 -bash
0 41247 40265 33126  20   0 114480  1208 -      R+   pts/1      0:00 ps l -U kkamg001
```
To modify one of these already running processes, we use [`renice`](http://linux.die.net/man/8/renice) rather than `nice`. Priorities may be set by pid, user, or process group. Assuming a background script owned by `root` is causing some user process to be less responsive, we can use renice to lower the priority of their current processes. 
```
kkamg001@hammer $ renice -n 19 -u root
0: old priority 0, new priority 19
```
This assigns them the lowest possible scheduling priority.

# nohup
`nohup` prevents a job from terminating when the parent process ends by redirecting output and ignoring `stdin`. Output is sent to the file `nohup.out` in the current working directory by default. Any errors remain directed to `stdout` unless they are explicitly redirected. This is especially useful when dealing with daemon processes, where the process must not be interrupted by termination of the calling process. For example let's say you need to manually [`cron`](http://linux.die.net/man/8/crond), which is responsible for running scheduled tasks described by a set of [`crontab`](http://linux.die.net/man/5/crontab) files. 
```
KavehKamgarsMBP:~ kaveh$ sudo kill 273
KavehKamgarsMBP:~ kaveh$ sudo nice -n 19 cron $PATH
cron: cron already running, pid: 273
```
In this case `cron` was already restarted.

## stdbuf
Data is buffered on input or output. This can cause problems with things that must be updated at intervals or filtered in some way. This only affects functions that work via streams, yet buffer changes invoked by a command will override manual changes made by [`stdbuf`](http://linux.die.net/man/1/stdbuf). In some cases it may be necessary to change the buffer size to better align with the rate of data transfer from an external piece of hardware such as an NIC or hardware bus. The more common use would be to switch between line buffering and a buffer size specified in bytes. Line buffering may not be used with `stdin`. 

## timeout
[`timeout`](http://linux.die.net/man/1/timeout) places a limit on the maximum amount of time a command may run prior to exiting. This may be specified in seconds (s), minutes (m), hours (h), or days (d). If no suffix is specified, the value is interpeted in seconds. The value may be specified in a floating point format. 

The default signal upon reaching duration is `SIGTERM`. This may be actively caught or ignored by the process. This can be remedied by `--kill`, which sends a kill signal in addition to the default signal. The signal can be modified to any available signal, and duration represents a floating point value. To run [`ping`](http://linux.die.net/man/8/ping) on site goggle.com with low priority and `SIGTERM` sent at the 30 second mark, the command would be 
```
kkamg001@hammer $ nice -n 19 timeout --signal=SIGTERM 30 ping goggle.com 
```
